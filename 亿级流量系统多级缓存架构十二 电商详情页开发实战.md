# 亿级流量系统多级缓存架构12 电商详情页开发实战





1.如果去面试，公司的实力和自己的能力都不强，让你做架构师，带团队你会去做吗？理由是啥？

2.描述一下互联网创业公司的产品从无到有，应该从哪里入手，包含哪些岗位分工？



## 静态化文件生成方案

客户端渲染与服务器端渲染。前者的例子是网游，上来只是返回一个页面的骨架，页面的渲染在客户端，客户端还会发出很多异步请求，富客户端；
后者的例子是一个table由60行，这60行的<td>都已经在服务器端就生成好了，然后往客户端推html，后者只需解析td就可以了，外加渲染基本的css。
前者只有一行模板，然后跑js加载请求返回来的json，，然后再循环渲染最终达到的效果是跟前一种是现实一样的。像是Vue等前端框架就做了很多这类
的事情后者客户端的压力比较小，低延迟的话就要选择后者  

聚合数据是现在各个微服务中拿到相应的数据，然后都放到Redis里面，所有聚合数据被读出来的时候是一个超级长的json，页面就可以拿着它去渲染。
这份数据的大小一般不超过500k，这对于server和client来说压力都非常大。这就要选择一些数据放在json里面，比如秒杀倒计时，在json里面给一个
秒杀过期时间，这个时间占用空间很小，这500k大是因为结构化的数据和富文本编辑器生成出来的html。整个富文本写在一个大字端粒会很灵活，比如不用
规定或者根据商品类型修改列名等。产品价格不适合放在这个大Json里面，因为它经常变化，而且价格一般会经过一个非常复杂严格的价格计算的系统。  

页面静态化：通过如Freemarker之类的东西，将页面静态化，它带来的好处是：不需要在总Controller或者缓存了。编辑详情页的时候，点击保存后，执行两步操作：
1。写数据库2。把刚刚写的东西生成一个静态页面，包含了所有需要的数据（从数据库里读取），生成静态页面的时候有一个模板引擎，来加载页面模板。页面模板+
数据=终极完整页面，这是在服务器端渲染的，客户端只有轻量级的渲染，这样会提高解析速度，坏处是提高了网络传输的数据量，里面的各种div、td就都来了。
这就要看对网络贷款是否敏感，手机用户通过弱网，访问页面的时候，就对数据量敏感了，不能做服务器端渲染，强网环境可以。

展示页面的方式：iFrame，js.load, document.write. iFrame简单，但会让爬虫看不懂，它只是看到了一段代码：frameset=src"..."，具体内容是
不可见的，还有地址栏的url怎么处理？想复用url的时候，header如果加载进来了，content由于网络抖动没加载进来，导致页面只显示出一半来，这样会
严重降低用户体验度，而且分的块越多治理起来越麻烦。另外一个缺点是会增加请求发送的次数，会造成socket上的一些浪费。对于js.load也一样，爬虫
不会知道load的内容，document.write更是如此。  

要生成几个文件好？用模版，头尾中间，3个？还是整体就一个？三个的话一旦页面需要有变化所有页面文件都要修改。三个的话，又回到了上面的情况。那怎么办呢？
可以在nginx这里写三块缓存，需要改的时候只改其中一块，然后每次请求过来都返回都包含着三块的数据。

可以通过模版引擎渲染出来模版（下面介绍），然后去加载数据，Nginx SSI （小型电商静态网页治理神器）这个技术，可以把本地磁盘上的两个文件include拼接
一下，在服务端生成一个大文件，三个模版三合一.在nginx.conf的server大括号下面：
```
ssi on;
ssi_silent_errors on;
ssi_types text/html;
```

header.html中写头部，body.html写中间的部分，tail.html写footer，这里由于配置了/foo这个 location,所以用tail.html代替footer.html
再写一个index.html：
```
<h1>Welcome to by iPhone 100</h1>
<!--#include file="header.html" -->
<!--#include file="body.html" -->
<!--#include file="tail.html" -->
```
其中`<!--#include`各个字符之间不能有空格，file="之间也不能有空格。这样再重启openresty：`service openresty reload`
然后刷新页面 `http://192.168.1.2` 就能看到把三个文件拼接之后的结果


Thymeleaf、Freemarker、还有JFinal（私活神器，干活太快了，还是国人写的，👍）。JFinal的设计理念在2012-2013年的时候是非常非常先进的，其本质是
mvc+orm和其他的一些组件。她有一个叫Enjoy的模版引擎，他想翻身就指望这个了。Thymeleaf、Freemarker、Velocity渲染的时候底层借助的是javacc：
语义、词义、词法的解析器，类似于一个编译器。Enjoy没用javacc，但是它的性能要比前几个高5倍左右，纯靠算法战胜的Freemarker和Thymeleaf，而且
他是咱们国产的框架，而且咱们还可以不用JFinal，只用Enjoy，不需要导入其他无关的依赖

### 管理后台

1. 发布新商品/添加商品流程

   事务中包含哪些操作

   1. 写db，强一致性
   2. 写缓存
   3. 生成文件

2. 生成文件

   文件结构化数据，分片，商品模板

   1. 直接生成
   2. 异步生成

3. 更新商品

## 缓存

## 先写DB还是先写缓存？

### Redis 大Key/value问题 

#### 什么是 大key/value？

- 字符串：大于10k
- hash、list、set、zset等 < 5000个

#### 问题

读取数据的时候网络阻塞，单线程处理网络请求，频繁出现等待，线程hang住，甚至超时。

LRU算法问题，当新增value过大时，导致占用空间过大，后续新增的value会把之前的顶掉，缓存命中率降低。

del大value的时候，或缓存过期后调起的的del操作，会造成线程阻塞

#### 解决方案

1. 压缩数据
2. 数据分组，客户端聚合 
   1. 手动拆分成几个k/v存储，mget取值，客户端手动合并，部分更新
   2. hset,hmset更新，存储hash结构在redis中，hgetall取出，key节省空间

## 静态数据补偿