# ES核心概念和原理
    1、什么是搜索：百度、垂直搜索（站内搜索）
        搜索：通过一个关键词或一段描述，得到你想要的（相关度高）结果。
    2、如何实现搜索功能?
        关系型数据库：性能差、不可靠、结果不准确（相关度低）%...%前面有百分号的时候，索引是不生效的 ...%索引会生效
        用了模糊查询是不能用索引的，因为索引是要对字段进行排序的，知道要搜的是以什么开始，然后就可以定位，但是有了%
        则无法确定以什么开头。走 select * from product where brand like '%小米NFC智能手机%' -> O(N) 索引是
        B+ tree存储。3GHz 64位 -> CPU每震荡一次吞吐量就是64 bits = 8 bytes。CPU > 100GB, 内存 20 -50 GB
        SSD硬盘，最快也就2-3GB. 所以尽量避免对磁盘的IO, 尤其是磁盘的随机读写
        倒排索引、Lucene和全文检索？用倒排索引的时候不会搞模糊查询
### 倒排索引的数据结构
    倒排索引的意思就是：根据关键词去造索引
#### 数据结构：  
    1. 包含这个关键词的document list （document就相当于关系型数据库里的一行）  
    2. 关键词在每个（一个）doc中出现的次数 TF term frequency  
    3. 关键词在整个索引中出现的次数 IDF inverse doc frequency. IDF越高，代表相关度越低  
    4. 关键词在当前doc中出现的次数  
    5. 每个doc的长度，越长相关度越低  
    6. 包含这个关键词的所有doc的平均长度  
Lucene：就是个jar包，帮我们创建倒排索引，并提供了复杂的API  

### 如果用Lucene做集群实现搜索，会有那些问题  
    1. Lucene是单节点的，做集群要用zk做高可用等，还得人工做负载均衡。单节点一旦宕机，节点数据丢失，后果不堪设想，可用性差。
       Ext4最大支持170多亿TB的硬盘空间  
    2. 自己维护，麻烦（自己创建管理索引），单台节点的承载请求的能力是有限的，需要人工做负载（雨露均沾）。 
     
### Elasticsearch：
    分布式、高性能、高可用、可伸缩、易维护. ES≠搜索引擎。中大型集群一般要横向扩容  
    1. 原生分布式的搜索，存储和数据分析引擎：  
    2. 优点：  
        1. 面向开发者友好，屏蔽了Lucene的复杂特性，集群自动发现（cluster discovery）当在集群内启动一个节点，
           ES会发现他并把他加到cluster中  
        2. 自动维护数据在多个节点上的建立  
        3. 会自动帮我们做搜索请求的负载均衡  
        4. 自动维护冗余副本，保证了部分节点宕机的情况下仍然不会有任何数据丢失  
        5. ES基于Lucene提供了很多高级功能：复合查询、聚合分析、基于地理位置（GeoHash）等。  
        6. 对于大公司，可以构建几百台服务器的大型分布式集群，处理PB级别数据；对于小公司，开箱即用，门槛低上手简单，不用考虑运维。
        7. 相对于传统数据库，提供了全文检索，同义词处理（美丽的cls>漂亮的cls），相关度排名。聚合分析以及海量数据的近实时
          （NTR）处理，这些传统数据库完全做不到。  
            
### 应用领域：
    1. 百度（全文检索、高亮、搜索推荐）  
    2. 各大网站的用户行为日志（用户点击、浏览、收藏、评论）  
    3. BI（Business Intelligence商业智能），数据分析：数据挖掘统计。  
       Github：代码托管平台，几千亿行代码  
       ELK：Elasticsearch（数据存储）、Logstash（日志采集）、Kibana（可视化）  
       
### ES核心概念：
    cluster（集群）：每个集群至少包含两个节点.
    node：集群中的每个节点，一个节点不代表一台服务器
    field：一个数据字段，与index和type一起，可以定位一个doc
    document：ES最小的数据单元, 可以理解为""行"  Json
    {
        "id": "1",
        "name": "小米",
        "price": {
            "标准版": 3999,
            "尊享版": 4999,
            "吴磊签名定制版": 19999
        }
    }
Type：逻辑上的数据分类，es 7.x中删除了type的概念。类比MySQL中的Table
Index：一类相同或者类似的doc，比如一个员工索引，商品索引。类比MySQL的DB
### Shard分片：
    1：一个index包含多个Shard，默认5个Primary Shard，默认每个Primary Shard分配一个Replica Shard，
       P的数量在创建索引的时候设置，如果想修改，需要重建索引。读写分离，副本分片不做写入操作，只做查询
    2：每个Shard都是一个Lucene实例，有完整的创建索引的处理请求能力。
    3：ES会自动在nodes上为我们做shard 均衡。ES自动为我们做shard rebalance
    4：一个doc是不可能同时存在于多个PShard中的，但是可以存在于多个RShard中。
    5: P和对应的R不能同时存在于同一个节点，所以最低的可用配置是两个节点，互为主备（不是说一台机器就完全不行，一台视为不可用）。
    6：shards是读写分离的，Primary shard可读写，replica shard的数据是从Primary 同步过来的

不同的数据（比如员工和order）存放在不同的索引里面。可能另一个数据正在被用作复杂的查询、聚合分析，这样就会互相干扰，查询速度变慢

### Master节点的任务

分片的均衡、索引和分片的创建删除、分发，做协调的。包括非master节点宕机，replica shard要变为主分片。ES的查询是CPU和IO密集型的